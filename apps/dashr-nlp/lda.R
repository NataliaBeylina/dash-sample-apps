library(topicmodels)
library(tidytext)
library(Rtsne)


build_dtm <- function(df) {
  # create stop list
  stop_words <- c("INC.", "Ltd.", "xxxxxxxx", "xxxxxxxxxxxxxxxx", "XXXX", "XX", "xx", "xxxx", "n't", "Trans Union", "BOA", "Citi", "account")
  stop_words <- tolower(stop_words)
  stop_words <- gsub(pattern = "\\,", "", stop_words)
  stop_words <- gsub(pattern = "\\.", "", stop_words)
  
  docs <- VCorpus(VectorSource(df$complaint))
  docs <- tm_map(docs, stripWhitespace)
  docs <- tm_map(docs, content_transformer(tolower))
  docs <- tm_map(docs, removeNumbers)
  docs <- tm_map(docs, removeWords, stopwords("english"))
  docs <- tm_map(docs, removePunctuation)
  docs <- tm_map(docs, stripWhitespace)
  docs <- tm_map(docs, removeWords, stop_words)
  # Create matrix for WCloud
  dtm <- DocumentTermMatrix(docs)
  
  return(dtm)
}


build_lda_topics <- function(dtm) {
  lda = LDA(dtm, k = 5, control = list(seed = 1234))
  topics <- tidy(lda, matrix = "beta")
  return(topics)
}

tsne_topics <- function(topics) {
  tsne <- Rtsne(topics)
  tsne_df <- as.data.frame(tsne$Y)
  return(tsne_df)
}



#stoplist_funct(df$complaint)

#tm_map(df$complaint[1])
#df$complaint[1]

top_terms <- function(topics) {
  ap_top_terms <- topics %>%
    group_by(topic) %>%
    top_n(3, beta) %>%
    ungroup() %>%
    arrange(topic, -beta)
  return(ap_top_terms)
}

build_lda_df <- function(df) {
  dtm <- build_dtm(df)
  ap_topics <- build_lda_topics(dtm)
  tsne_df <- tsne_topics(ap_topics)
  return(cbind(ap_topics, tsne_df))
}

#df <- filtered_data(100, "Harris & Harris, Ltd.", 0, as.integer(Sys.time()))

#tsne_df <- build_lda_df(df)

#ggplot(tsne_df)+geom_point(aes(x=V1, y=V2, col=as.factor(topic)))



